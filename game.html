<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<meta name="author" content="Quist Quest" />
	<meta name="keywords" content="Game, HTML5, HTML, CSS, JavaScript" />
	<meta name="description" content="Quist Quest - Defend the Knowledge" />
	<title>Quist Quest - Defend the Knowledge</title>
	<link rel="stylesheet" type="text/css" href="resources/css/game-ui.css" />
	<link rel="stylesheet" href="resources/css/animationContainerStyle.css">
	<link rel="stylesheet" href="resources/css/knight.css">
	<link rel="stylesheet" href="resources/css/slime.css">
	<link rel="stylesheet" href="resources/css/golem.css">
	<link rel="stylesheet" href="resources/css/jellyfish.css">
	<link rel="stylesheet" href="resources/css/skeleton.css">
	<link rel="stylesheet" href="resources/css/slimeBoss.css">
</head>

<body>
	<div id="fullscreen">
		<div id="gameDiv" class="game-container">
			<!-- Next level stat -->
			<div id="nextLevelDiv" class="next-level-stat" data-hidden="true">
				<img src="./assets/games ui/Next Level.png" loading="lazy" alt="Next level stat" />
			</div>

			<!-- Game field -->
			<div class="game-field">
				<div class="level-indicator-container">
					<div id="levelIndicator" class="level-indicator">Level: 1</div>
					<div id="waveIndicator" class="wave-indicator">Wave: 1 of 5</div>
				</div>
				<div class="ground">
					<div id="btnFullscreenToggle">
						toggle fullscreen
					</div>
				</div>

				<div id="gameAnimationContainer">
					<div id="allyContainer">
						<div id="knight" data-animate="idle">
							<div class="idle"></div>
							<div class="walk"></div>
							<div class="attack"></div>
							<div class="damaged"></div>
							<div class="died"></div>
						</div>
					</div>
					<div id="enemyContainer" class="">
						<div id="slime" data-animate="">
							<div class="idle"></div>
							<div class="walk"></div>
							<div class="attack"></div>
							<div class="damaged"></div>
							<div class="died"></div>
						</div>
						<div id="golem" data-animate="">
							<div class="idle"></div>
							<div class="walk"></div>
							<div class="attack"></div>
							<div class="damaged"></div>
							<div class="died"></div>
						</div>
						<div id="jellyfish" data-animate="">
							<div class="idle"></div>
							<div class="walk"></div>
							<div class="attack"></div>
							<div class="damaged"></div>
							<div class="died"></div>
						</div>
						<div id="skeleton" data-animate="">
							<div class="idle"></div>
							<div class="walk"></div>
							<div class="attack"></div>
							<div class="damaged"></div>
							<div class="died"></div>
						</div>
						<div id="slimeBoss" data-animate="">
							<div class="idle"></div>
							<div class="walk"></div>
							<div class="attack"></div>
							<div class="damaged"></div>
							<div class="died"></div>
						</div>
					</div>
				</div>
				<!-- Player info -->
				<div class="player-info-container">
					<div class="player-avatar">
						<!-- <img src="" class="player-sprite" loading="lazy" alt="Knight" /> -->
						<div class="knight-avatar"></div>
						<!-- <div>halo</div> -->
					</div>
					<div class="player-stats ui-box">
						<div class="player-name">Player</div>
						<div class="hp-bar">
							<div id="playerHpBar" class="hp-bar-fill" style="rotate: 180deg; left: 0;"></div>
							<div id="playerHpText" class="hp-text">100/100</div>
						</div>
					</div>
				</div>

				<!-- Enemy info -->
				<div id="enemyInfo" class="enemy-info-container" data-enemy-name="">
					<div class="enemy-stats ui-box">
						<div class="enemy-name">
							<div class="name-slime">Slime</div>
							<div class="name-golem">Golem</div>
							<div class="name-jellyfish">Jellyfish</div>
							<div class="name-skeleton">Skeleton</div>
							<div class="name-slimeBoss">Slime Boss</div>
						</div>
						<div class="hp-bar">
							<div id="enemyHpBar" class="hp-bar-fill" style="right: 0;"></div>
							<div id="enemyHpText" class="hp-text">100/100</div>
						</div>
					</div>
					<div class="enemy-avatar">
						<div class="slime-avatar"></div>
						<div class="golem-avatar"></div>
						<div class="jellyfish-avatar"></div>
						<div class="skeleton-avatar"></div>
						<div class="slimeBoss-avatar"></div>
					</div>
				</div>

				<!-- Mana bar -->
				<!-- <div
            class="mana-bar"
            style="position: absolute; left: 20px; top: 110px"
            >
                <div class="mana-text">10/100</div>
            </div> -->

				<!-- Biome background -->
				<div class="biome-background"></div>
			</div>

			<div class="question-container" data-answer-result="">
				<div id="question" class="question">1+1=?</div>
				<div id="timer" class="question-timer">
					<div id="questionTimerBar" class="question-timer-fill"></div>
					<div id="questionTimerText" class="question-timer-text">1 seconds</div>
				</div>
				<div id="options" class="options-container">
					<div class="option option-1"></div>
					<div class="option option-2"></div>
					<div class="option option-3"></div>
					<div class="option option-4"></div>
				</div>

				<div class="stats-container">
					<div class="correct-answer">
						<img src="./assets/games ui/BENAR!.png" loading="lazy" alt="Correct answer" />
					</div>
					<div class="wrong-answer">
						<img src="./assets/games ui/SALAH!.png" loading="lazy" alt="Wrong answer" />
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		class Character {
			constructor(element, name, health, attack, defense, isEnemy = true) {
				this.element = element;
				this.name = name;
				this.maxHealth = health;
				this.health = health;
				this.attack = attack;
				this.defense = defense;
				this.isEnemy = isEnemy;
				this.healthElement = document.getElementById(name.toLowerCase() + "Health");

				// Assign the correct HP bar elements
				if (isEnemy) {
					this.hpBar = document.getElementById("enemyHpBar");
					this.hpText = document.getElementById("enemyHpText");
				} else {
					this.hpBar = document.getElementById("playerHpBar");
					this.hpText = document.getElementById("playerHpText");
				}

				this.updateHealthDisplay();
			}

			updateHealthDisplay() {
				const percent = (this.health / this.maxHealth) * 100;
				this.hpBar.style.width = percent + "%";
				this.hpText.innerText = `${this.health} / ${this.maxHealth}`;
			}

			async performAttack(target) {
				let damage = Math.max(this.attack - target.defense, 0);
				if (!this.isEnemy) {
					await animateKnightAttack(target.element);
				} else {
					await animateSlimeAttack(this.element);
				}

				if (damage > 0) {
					target.health -= damage;
					target.health = Math.max(target.health, 0);
					console.log(`${this.name} attacks ${target.name} for ${damage} damage.`);
					target.updateHealthDisplay();
				}
			}
		}

		// Attack animation function
		let $allyContainer = document.getElementById("allyContainer");
		let $knight = document.getElementById("knight");

		async function animateKnightAttack(enemyElement) {
			$allyContainer.classList.add("move", "z-100");
			$knight.dataset.animate = "walk";
			await delay(700);
			$knight.dataset.animate = "idle";
			await delay(100);
			$knight.dataset.animate = "attack";
			await delay(200);
			enemyElement.dataset.animate = "damaged";
			await delay(300);
			enemyElement.dataset.animate = "idle";
			$knight.dataset.animate = "walk";
			$allyContainer.classList.replace("move", "move-back");
			await delay(700);
			$knight.dataset.animate = "idle";
			$allyContainer.classList.remove("move-back", "z-100");
		}

		// HP bar update functions
		let $playerHpBar = document.getElementById("playerHpBar");
		let $playerHptext = document.getElementById("playerHpText");

		function changePlayerHpBar($maxHp, $currentHp) {
			const percent = ($currentHp / $maxHp) * 100;
			$playerHpBar.style.width = percent + "%";
			$playerHptext.innerText = `${$currentHp} / ${$maxHp}`;
		}

		let $enemyHpBar = document.getElementById("enemyHpBar");
		let $enemyHptext = document.getElementById("enemyHpText");

		function changeEnemyHpBar($maxHp, $currentHp) {
			const percent = ($currentHp / $maxHp) * 100;
			$enemyHpBar.style.width = percent + "%";
			$enemyHptext.innerText = `${$currentHp} / ${$maxHp}`;
		}

		function delay(ms) {
			return new Promise((resolve) => setTimeout(resolve, ms));
		}

		document.addEventListener("DOMContentLoaded", function () {
			let $fullscreenDiv = document.getElementById('fullscreen');
			let $gameDiv = document.getElementById('gameDiv');
			let $isFullScreen = false;
			let $defaultScale = 1;
			$defaultScale = Math.min(document.documentElement.clientWidth / 1280, document.documentElement.clientHeight / 720) - 0.05;
			$gameDiv.style.scale = $defaultScale;
			document.getElementById('btnFullscreenToggle').addEventListener('click', function () {
				if ($isFullScreen) {
					document.exitFullscreen();
					return;
				}
				$fullscreenDiv.requestFullscreen();
			})
			document.addEventListener("fullscreenchange", () => {
				if (!document.fullscreenElement) {
					$gameDiv.style.scale = $defaultScale;
					$gameDiv.style.translate = '0 50vh';
					$isFullScreen = false;
				} else {
					const scale = Math.min($fullscreenDiv.offsetWidth / 1280, $fullscreenDiv.offsetHeight / 720);
					$gameDiv.style.scale = scale;
					$gameDiv.style.translate = '0';
					$isFullScreen = true;
				}
			});

			window.addEventListener('resize', function () {
				const scale = Math.min(document.documentElement.clientWidth / 1280, document.documentElement.clientHeight / 720) - 0.05;
				$gameDiv.style.scale = $defaultScale = scale;
			});

			let $knight = document.getElementById("knight");
			let $slime = document.getElementById("slime");

			let $levelIndicator = document.getElementById('levelIndicator');
			let $waveIndicator = document.getElementById('waveIndicator');

			function updateLevelAndWave($level, $wave) {
				$levelIndicator.innerHTML = 'Level: ' + $level;
				$waveIndicator.innerHTML = 'Wave: ' + $wave + ' out of 5';
			}

			let knight = new Character($knight, "Knight", 100, 10, 5);
			let slime = new Character($slime, "Slime", 100, 10, 5, true);

			let $enemyContainer = document.getElementById("enemyContainer");

			async function animateSlimeAttack() {
				$enemyContainer.classList.add("move-slime");
				$slime.dataset.animate = "walk";
				await delay(1400);
				$slime.dataset.animate = "idle";
				await delay(200);
				$slime.dataset.animate = "attack";
				await delay(210);
				$knight.dataset.animate = "damaged";
				await delay(280);
				$slime.dataset.animate = "idle";
				$knight.dataset.animate = "idle";
				await delay(100);
				$enemyContainer.classList.replace("move-slime", "move-back-slime");
				$slime.dataset.animate = "walk_fliped";
				await delay(1700);
				$slime.dataset.animate = "idle";
				$enemyContainer.classList.remove("move-back-slime");
			}

			let $golem = document.getElementById("golem");

			async function animateGolemAttack() {
				$enemyContainer.classList.add("move-golem");
				$golem.dataset.animate = "walk";
				await delay(1030);
				$golem.dataset.animate = "idle";
				await delay(200);
				$enemyContainer.classList.replace("move-golem", "move-golem-attack");
				$golem.dataset.animate = "attack";
				await delay(900);
				$knight.dataset.animate = "damaged";
				await delay(200);
				$knight.dataset.animate = "idle";
				$golem.dataset.animate = "idle";
				await delay(300);
				$golem.dataset.animate = "walk_fliped";
				$enemyContainer.classList.replace(
					"move-golem-attack",
					"move-back-golem"
				);
				await delay(1200);
				$enemyContainer.classList.remove("move-back-golem");
				$golem.dataset.animate = "idle";
			}

			let $jellyfish = document.getElementById("jellyfish");

			async function animateJellyfishAttack() {
				$jellyfish.dataset.animate = "walk";
				$enemyContainer.classList.add("move-jellyfish");
				await delay(1600);
				$jellyfish.dataset.animate = "idle";
				await delay(200);
				$jellyfish.dataset.animate = "attack";
				await delay(200);
				$knight.dataset.animate = "shocked";
				await delay(800);
				$jellyfish.dataset.animate = "idle";
				$knight.dataset.animate = "idle";
				await delay(200);
				$jellyfish.dataset.animate = "walk-back";
				$enemyContainer.classList.replace(
					"move-jellyfish",
					"move-back-jellyfish"
				);
				await delay(1500);
				$jellyfish.dataset.animate = "idle";
				$enemyContainer.classList.remove("move-back-jellyfish");
			}

			let $skeleton = document.getElementById("skeleton");

			async function animateSkeletonAttack() {
				$skeleton.dataset.animate = "walk";
				$enemyContainer.classList.add("move-skeleton");
				await delay(1000);
				$skeleton.dataset.animate = "idle";
				await delay(200);
				$skeleton.dataset.animate = "attack";
				await delay(160);
				$knight.dataset.animate = "damaged";
				await delay(110);
				$skeleton.dataset.animate = "idle";
				await delay(90);
				$knight.dataset.animate = "idle";
				await delay(200);
				$skeleton.dataset.animate = "walk_fliped";
				$enemyContainer.classList.replace(
					"move-skeleton",
					"move-back-skeleton"
				);
				await delay(1000);
				$skeleton.dataset.animate = "idle";
				$enemyContainer.classList.remove("move-back-skeleton");
			}

			let $slimeBoss = document.getElementById("slimeBoss");

			async function animateSlimeBossAttack() {
				$slimeBoss.dataset.animate = "attack";
				$enemyContainer.classList.add("move-slimeBoss");
				await delay(1800);
				$knight.dataset.animate = "damaged";
				await delay(200);
				$knight.dataset.animate = "idle";
				$slimeBoss.dataset.animate = "idle";
				await delay(200);
				$slimeBoss.dataset.animate = "jump-back";
				$enemyContainer.classList.replace(
					"move-slimeBoss",
					"move-back-slimeBoss"
				);
				await delay(2000);
				$slimeBoss.dataset.animate = "idle";
				$enemyContainer.classList.remove("move-back-slimeBoss");
			}

			let $playerHpBar = document.getElementById('playerHpBar');
			let $playerHptext = document.getElementById('playerHpText');
			function changePlayerHpBar($maxHp, $currentHp) {
				$percent = ($currentHp / $maxHp) * 100;
				$playerHpBar.style.width = $percent + '%';
				$playerHptext.innerText = $currentHp + '/' + $maxHp;
			}
			let $enemyHpBar = document.getElementById('enemyHpBar');
			let $enemyHptext = document.getElementById('enemyHpText');
			function changeEnemyHpBar($maxHp, $currentHp) {
				$percent = ($currentHp / $maxHp) * 100;
				$enemyHpBar.style.width = $percent + '%';
				$enemyHptext.innerText = $currentHp + '/' + $maxHp;
			}
			let $questionDiv = document.getElementById('question');
			let $optionsDiv = document.querySelectorAll('#options>.option');
			let $questionTimerBar = document.getElementById('questionTimerBar');
			let $questionTimerText = document.getElementById('questionTimerText');
			let $isTimerCounting = false;
			async function setQuestionTimer($miliseconds) {
				$isTimerCounting = true;
				$questionTimerBar.style.display = 'block';

				let startTime = null;
				let startPosition = 100;
				let endPosition = 0;

				function animateQuestionBar(timestamp) {
					if (!startTime) startTime = timestamp;

					let elapsedTime = timestamp - startTime;
					let progress = Math.min(elapsedTime / $miliseconds, 1);

					let currentPosition = startPosition + (endPosition - startPosition) * progress;
					$questionTimerBar.style.width = currentPosition + '%';
					let remainingTime = (Math.round(($miliseconds - elapsedTime)) / 1000).toFixed(2)
					if (remainingTime > 0) { $questionTimerText.innerHTML = remainingTime + 's' } else { $questionTimerText.innerHTML = '0.00s' };

					if ((progress < 1) && $isTimerCounting) {
						requestAnimationFrame(animateQuestionBar);
					}
				}

				requestAnimationFrame(animateQuestionBar);
			}

			let $enemyInfoDiv = document.getElementById('enemyInfo');
			let $answerResultDiv = document.querySelector('[data-answer-result]');
			let $nextLevelAlertDiv = document.getElementById('nextLevelDiv');

			$answerResultDiv.dataset.answerResult = 'true';

			function adjustFontSize(div) {
				let fontSize = 30;
				let minFontSize = 15;
				div.style.fontSize = fontSize + "px";

				while ((div.scrollHeight > div.clientHeight || div.scrollWidth > div.clientWidth) && fontSize > minFontSize) {
					fontSize -= 5;
					div.style.fontSize = fontSize + "px";
				}
				div.style.fontSize = fontSize + "px";
			}
			// contoh update question dan options, simpel si (umar: wau simpel sekali)
			async function loadQuestion() {
				try {
					const response = await fetch("/resources/questions.json");
					const data = await response.json();

					let questions = data.quiz || [];

					// Generate a random math question
					const num1 = Math.floor(Math.random() * 100) + 1;
					const num2 = Math.floor(Math.random() * 100) + 1;
					const operators = ["+", "-", "*", "/"];
					const operator = operators[Math.floor(Math.random() * operators.length)];
					let answer;

					switch (operator) {
						case "+":
							answer = num1 + num2;
							break;
						case "-":
							answer = num1 - num2;
							break;
						case "*":
							answer = num1 * num2;
							break;
						case "/":
							answer = (num1 / num2).toFixed(2); // Limit division to 2 decimal places
							break;
					}

					const mathQuestion = {
						question: `What is ${num1} ${operator} ${num2}?`,
						options: [
							answer,
							answer + Math.floor(Math.random() * 10) + 1,
							answer - Math.floor(Math.random() * 10) + 1,
							answer + Math.floor(Math.random() * 5) + 1
						].sort(() => Math.random() - 0.5), // Shuffle options
						answer: answer
					};

					// Mix the questions
					questions.push(mathQuestion);
					const randomIndex = Math.floor(Math.random() * questions.length);
					const currentQuestion = questions[randomIndex];

					// Set question and options dynamically
					$questionDiv.innerHTML = currentQuestion.question;

					$optionsDiv.forEach((button, index) => {
						if (currentQuestion.options[index] !== undefined) {
							button.innerHTML = currentQuestion.options[index];
							button.onclick = () => checkAnswer(currentQuestion.options[index], currentQuestion.answer);
						}
						adjustFontSize(button);
					});
				} catch (error) {
					console.error("Error loading questions:", error);
				}
			}

			function checkAnswer(selected, correct) {
				if (selected === correct) {
					console.log("Correct!");
					knight.performAttack(slime);
				} else {
					console.log("Wrong answer.");
					slime.performAttack(knight);
				}
				setTimeout(loadQuestion, 1000); // Load next question after a delay
			}

			// // contoh update question dan options
			//$optionDiv[_] juga bisa dipake buat kasih .addEventListener()

			// contoh ngedisplay alert jawaban benar ato salah [true, false], kosongkan untuk menghilangkan alert 
			$answerResultDiv.dataset.answerResult = "";
			// contoh ngedisplay alert jawaban benar ato salah



			// contoh ngedisplay alert next level [true, false]
			$nextLevelAlertDiv.dataset.hidden = true;
			// // contoh ngedisplay alert next level

			// contoh update level dan wave display
			updateLevelAndWave(4, 2);

			// contoh cara jalanin timer display (otomatis langsung jalan setelah fungsi dipanggil)
			setQuestionTimer(4000);
			setTimeout(() => {
				$isTimerCounting = false; // to stop timer do this
			}, 3220);
			// contoh cara jalanin timer display

			// cara ubah avatar dan nama [slime, golem, jellyfish, skeleton, slimeBoss]
			$enemyInfoDiv.dataset.enemyName = 'slime';
			// // cara ubah avatar dan nama

			// contoh cara spawn enemy
			$slime.dataset.animate = 'idle';
			// $golem.dataset.animate = 'idle';
			// $skeleton.dataset.animate = 'idle';
			// $jellyfish.dataset.animate = 'idle';
			// $slimeBoss.dataset.animate = 'idle';
			// // contoh cara spawn enemy
			// cara despawn tinggal dibikin $__.dataset.animate = 'died';

			// contoh jalanin animasi
			animateKnightAttack(document.querySelector('#enemyContainer>[data-animate="idle"]'));
			// animateSlimeAttack();
			// animateGolemAttack();
			// animateSkeletonAttack();
			// animateJellyfishAttack();
			// animateSlimeBossAttack();
			// // contoh jalanin animasi

			// contoh ubah hp
			// changePlayerHpBar(100, 50);
			// changeEnemyHpBar(50, 20);
			// // contoh ubah hp
			loadQuestion();
		});
	</script>
</body>

</html>